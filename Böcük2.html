<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitki Analiz UzmanÄ±</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome (ikonlar iÃ§in) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Temel stiller */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* YÃ¼kleme animasyonu iÃ§in */
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* Markdown Ã§Ä±ktÄ±sÄ±ndaki baÅŸlÄ±klar iÃ§in stil */
        #analysisResult h1 {
            font-size: 1.875rem; /* 3xl */
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb; /* gray-200 */
            padding-bottom: 0.25rem;
            color: #166534; /* green-800 */
        }

        #analysisResult h2 {
            font-size: 1.5rem; /* 2xl */
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            color: #15803d; /* green-700 */
            border-left: 4px solid #22c55e; /* green-500 */
            padding-left: 0.75rem;
        }
        
        #analysisResult h3 {
            font-size: 1.25rem; /* xl */
            font-weight: 600;
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
            color: #1f2937; /* gray-800 */
        }

        #analysisResult ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            margin-bottom: 0.75rem;
        }

        #analysisResult p {
            margin-bottom: 0.75rem;
            line-height: 1.6;
            color: #374151; /* gray-700 */
        }

        #analysisResult a {
            color: #2563eb; /* blue-600 */
            text-decoration: none;
            font-weight: 500;
            background-color: #eff6ff;
            padding: 2px 6px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        #analysisResult a:hover {
            background-color: #dbeafe;
            text-decoration: underline;
        }
        
        #analysisResult strong {
            font-weight: 600;
            color: #111827; /* gray-900 */
        }
        
        /* Grafik stilleri */
        .bar-chart-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            width: 100%;
            height: 160px;
            background-color: #f9fafb; /* gray-50 */
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 0.5rem;
            padding: 1rem 0.5rem;
            box-sizing: border-box;
            gap: 4px;
            margin-top: 1rem;
            margin-bottom: 1.5rem;
        }

        .bar-chart-month {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            flex-grow: 1;
            text-align: center;
            font-size: 0.7rem; /* text-xs */
            color: #6b7280; /* gray-500 */
            height: 100%;
        }

        .bar {
            width: 80%;
            border-radius: 0.25rem 0.25rem 0 0;
            transition: height 0.5s ease-out;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="container mx-auto max-w-4xl w-full bg-white rounded-xl shadow-2xl overflow-hidden">
        
        <!-- BaÅŸlÄ±k AlanÄ± -->
        <header class="bg-gradient-to-r from-green-600 to-emerald-700 text-white p-6 shadow-md">
            <h1 class="text-3xl font-bold flex items-center justify-center">
                <i class="fa-solid fa-leaf mr-3"></i>
                Bitki Analiz UzmanÄ±
            </h1>
            <p class="text-center text-green-100 mt-2">Bitki saÄŸlÄ±ÄŸÄ±, gÃ¼breleme ve sulama iÃ§in yapay zeka destekli rehberiniz.</p>
        </header>

        <!-- Ana Ä°Ã§erik AlanÄ± -->
        <main class="p-6 md:p-8">

            <!-- GiriÅŸ AlanÄ± (Metin ve FotoÄŸraf) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- FotoÄŸraf YÃ¼kleme -->
                <div class="flex flex-col items-center justify-center bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-6 text-center h-full hover:bg-gray-100 transition duration-300 group">
                    <i class="fa-solid fa-cloud-arrow-up text-4xl text-gray-400 mb-3 group-hover:text-green-500 transition"></i>
                    <label for="imageUpload" class="cursor-pointer bg-white text-gray-700 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm hover:bg-green-50 hover:text-green-700 hover:border-green-300 transition">
                        FotoÄŸraf YÃ¼kle
                    </label>
                    <input type="file" id="imageUpload" class="hidden" accept="image/*">
                    <p class="text-xs text-gray-500 mt-3">PNG, JPG, veya WEBP.</p>
                    <img id="imagePreview" src="" alt="YÃ¼klenen Bitki" class="hidden mt-4 rounded-lg object-cover h-40 w-40 shadow-sm border border-gray-200">
                </div>

                <!-- Metin AÃ§Ä±klamasÄ± -->
                <div class="flex flex-col h-full">
                    <label for="prompt" class="block text-sm font-medium text-gray-700 mb-2">Bitki Durumu veya Sorunuz (Opsiyonel)</label>
                    <textarea id="prompt" rows="5"
                        class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 transition resize-none h-full"
                        placeholder="Ã–rn: 'Yapraklarda sarÄ± lekeler ve beyaz pamukÃ§uklar var. Bu nedir?' veya 'BuÄŸday iÃ§in gÃ¼breleme takvimi nedir?'"></textarea>
                </div>
            </div>
            
            <!-- Konum ve Analiz ButonlarÄ± -->
            <div class="flex flex-col md:flex-row gap-4 mb-6">
                 <!-- Konum Butonu -->
                 <button id="locationButton" class="w-full md:w-auto flex-shrink-0 flex items-center justify-center px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    <i class="fa-solid fa-location-crosshairs mr-2"></i>
                    <span id="locationText">Hava Durumu iÃ§in Konum Al</span>
                </button>

                <!-- Analiz Butonu -->
                <button id="analyzeButton" class="w-full md:flex-grow px-6 py-3 bg-green-600 text-white text-lg font-bold rounded-lg shadow-lg hover:bg-green-700 transition duration-300 ease-in-out transform hover:-translate-y-1 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                    <i class="fa-solid fa-microscope mr-2"></i>
                    Analiz Et
                </button>
            </div>


            <!-- SonuÃ§ AlanÄ± -->
            <div id="resultContainer" class="mt-6">
                <!-- YÃ¼kleniyor... -->
                <div id="loadingIndicator" class="hidden flex-col items-center justify-center p-12 text-center">
                    <div class="loader w-12 h-12 rounded-full border-4 border-gray-200 mb-4"></div>
                    <p class="text-lg font-semibold text-gray-700">Bitkiniz analiz ediliyor...</p>
                    <p class="text-sm text-gray-500 mt-1">GÃ¶rÃ¼ntÃ¼ sunucuya iletiliyor, yapay zeka yanÄ±tÄ± bekleniyor...</p>
                </div>
                
                <!-- Hata MesajÄ± -->
                <div id="errorContainer" class="hidden p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                    <h3 class="font-bold flex items-center"><i class="fa-solid fa-circle-exclamation mr-2"></i>Hata!</h3>
                    <p id="errorMessage" class="mt-1">Analiz yapÄ±lÄ±rken bir sorun oluÅŸtu.</p>
                </div>
                
                <!-- Analiz Sonucu -->
                <div id="analysisResult" class="p-8 bg-white border border-gray-200 rounded-lg shadow-inner prose max-w-none">
                    <!-- SonuÃ§ buraya eklenecek -->
                    <div class="text-center text-gray-400 py-10">
                        <i class="fa-solid fa-file-medical text-6xl mb-4 opacity-50"></i>
                        <p class="text-xl font-medium">Analiz raporu burada gÃ¶rÃ¼ntÃ¼lenecek.</p>
                        <p class="text-sm mt-2">LÃ¼tfen fotoÄŸraf yÃ¼kleyin veya soru sorun, ardÄ±ndan 'Analiz Et' butonuna basÄ±n.</p>
                        <p class="text-xs text-orange-500 mt-4">Not: Bu sÃ¼rÃ¼m Backend API gerektirir. Yerel Ã¶nizlemede Ã§alÄ±ÅŸmaz.</p>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Marked.js (Markdown'Ä± HTML'e Ã§evirmek iÃ§in) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Ana JavaScript Kodu -->
    <script>
        // --- API AyarlarÄ± ---
        
        // Ã–NEMLÄ°: Hava durumu Ã¶zelliÄŸi Frontend'de kaldÄ±ÄŸÄ± iÃ§in bu anahtara burada ihtiyacÄ±mÄ±z var.
        // openweathermap.org sitesinden Ã¼cretsiz bir API anahtarÄ± alÄ±p buraya yapÄ±ÅŸtÄ±rÄ±n.
        const WEATHER_API_KEY = "BURAYA_KENDI_API_ANAHTARINIZI_YAPISTIRIN"; 
        
        // NOT: Gemini API anahtarÄ± artÄ±k burada DEÄÄ°L, sunucu tarafÄ±nda (api/analyze.js) saklanÄ±yor.

        // Gemini API'nin sistem talimatÄ± (prompt). Modelin nasÄ±l davranacaÄŸÄ±nÄ± belirler.
        const systemPrompt = `
Sen, 'Agro-Botanist AI' adlÄ± bir tarÄ±msal Ã¼retim ve bitki saÄŸlÄ±ÄŸÄ± uzmanÄ± yapay zekÃ¢sÄ±sÄ±n.
KullanÄ±cÄ±, bir bitki fotoÄŸrafÄ±, aÃ§Ä±klama veya konum bilgisi gÃ¶nderdiÄŸinde aÅŸaÄŸÄ±daki adÄ±mlarÄ± uygula.
AmacÄ±n; bitki tÃ¼rÃ¼nÃ¼, hastalÄ±k veya zararlÄ±yÄ± tanÄ±mak, uygun ilaÃ§lamaâ€“gÃ¼brelemeâ€“sulama planÄ± Ã¶nermek ve bakÄ±m takvimi oluÅŸturmaktÄ±r.
Google Arama aracÄ±nÄ± **mutlaka ve aktif olarak kullanarak**, Ã¶nerilerini destekleyecek (Ã¶r. ilaÃ§lama, gÃ¼breleme, bakÄ±m) gÃ¼ncel YouTube videolarÄ± bulmak ve rapor formatÄ±na eklemek ZORUNDASIN.

EÄŸer kullanÄ±cÄ± konum bilgisi ve hava durumu tahmini (Ã¶rn: "Konum: KarabÃ¼k, 5 gÃ¼nlÃ¼k tahmin: YaÄŸmurlu...") saÄŸlarsa, bu veriyi analiz ederek **"5 GÃ¼nlÃ¼k Hava Durumuna BaÄŸlÄ± BakÄ±m Takvimi"** oluÅŸturmalÄ±sÄ±n. Bu takvimde her gÃ¼n iÃ§in hava durumuna gÃ¶re Ã¶zel bir Ã¶neri ver (Ã¶rn: "YaÄŸmur var, sulama yapma").

Raporunu AÅAÄIDAKÄ° FORMATTA OLUÅTUR:

# ğŸŒ¿ Bitki Analiz Raporu
* **Analiz Tarihi:** [BugÃ¼nÃ¼n Tarihi]
* **Lokasyon:** [Åehir/BÃ¶lge (Verildiyse)]

## ğŸ” 1. Bitki TÃ¼rÃ¼ Tespiti
* **Bitki AdÄ±:** [Bitkinin yaygÄ±n adÄ±]
* **Bilimsel AdÄ±:** *[Latince adÄ±]*
* **Bitki Tipi:** [TarÄ±m Bitkisi / Ev-SÃ¼s Bitkisi]
* **OlasÄ± Benzer TÃ¼rler:** [KarÄ±ÅŸtÄ±rÄ±labileceÄŸi 1-2 tÃ¼r]

## ğŸ¦  2. HastalÄ±k / ZararlÄ± Tespiti
* **Durum:** [HastalÄ±k adÄ± / ZararlÄ± adÄ± / 'SaÄŸlÄ±klÄ±']
* **Belirtiler:** [GÃ¶rÃ¼len semptomlar]
* **Nedenler:** [OlasÄ± sebepler (nem, sÄ±caklÄ±k, vb.)]
* **Åiddet DÃ¼zeyi:** [Hafif / Orta / Ä°leri DÃ¼zey]

## ğŸ’Š 3. Tedavi ve Koruma Ã–nerileri
* **Kimyasal MÃ¼cadele:** [Etken madde veya ticari ilaÃ§ ismi.]
* **Uygulama:** [NasÄ±l ve ne zaman uygulanmalÄ±?]
* **DoÄŸal YÃ¶ntemler:** [Ev yapÄ±mÄ± veya organik Ã§Ã¶zÃ¼mler.]
* **YardÄ±mcÄ± YouTube VideolarÄ±:**
    <!-- MODEL ZORUNLU: Google Arama'yÄ± kullanarak 1-2 adet YARDIMCI VÄ°DEO bul. -->
    * *<a href="YouTube Linki" target="_blank" rel="noopener noreferrer"><i class="fa-brands fa-youtube text-red-600 mr-1"></i> [Video BaÅŸlÄ±ÄŸÄ±]</a>* - Video iÃ§eriÄŸinin kÄ±sa bir Ã¶zeti.
    * *(Video bulunamazsa bu satÄ±rÄ± silin)*

---

## ğŸ—“ï¸ 4. Hava Durumuna BaÄŸlÄ± 5 GÃ¼nlÃ¼k BakÄ±m PlanÄ±
*(Bu bÃ¶lÃ¼mÃ¼ SADECE konum ve hava durumu verisi saÄŸlandÄ±ysa doldur. SaÄŸlanmadÄ±ysa "Konum verisi alÄ±namadÄ±ÄŸÄ± iÃ§in hava durumuna dayalÄ± plan oluÅŸturulamadÄ±." yaz.)*

* **GÃ¼n 1 ([Hava Durumu Ã–zeti]):** [O gÃ¼n iÃ§in spesifik Ã¶neri. Ã–rn: "BugÃ¼n hava aÃ§Ä±k, sulama iÃ§in uygun."]
* **GÃ¼n 2 ([Hava Durumu Ã–zeti]):** [Ã–rn: "Åiddetli yaÄŸmur bekleniyor, gÃ¼breleme yapmayÄ±n, ilaÃ§lamayÄ± erteleyin."]
* **GÃ¼n 3 ([Hava Durumu Ã–zeti]):** [Ã–rn: "RÃ¼zgarlÄ±, ilaÃ§lama yapmaktan kaÃ§Ä±nÄ±n."]
* **GÃ¼n 4 ([Hava Durumu Ã–zeti]):** [...]
* **GÃ¼n 5 ([Hava Durumu Ã–zeti]):** [...]

---
<!-- MODEL: EÄŸer Bitki Tipi "TarÄ±m Bitkisi" (BuÄŸday, MÄ±sÄ±r, Pamuk vb.) ise AÅAÄIDAKÄ° BÃ–LÃœMLERÄ° KULLAN. -->

## ğŸŒ¾ 5. GÃ¼breleme PlanÄ± (TarÄ±m Bitkisi)
* **Taban GÃ¼bresi:** [GÃ¼bre tipi, miktar, zaman.]
* **Ãœst GÃ¼breleme:** [GÃ¼bre tipi, miktar, zaman.]
* **YardÄ±mcÄ± YouTube VideolarÄ±:**
    * *<a href="YouTube Linki" target="_blank" rel="noopener noreferrer"><i class="fa-brands fa-youtube text-red-600 mr-1"></i> [Video BaÅŸlÄ±ÄŸÄ±]</a>*

### ğŸ“Š YÄ±llÄ±k GÃ¼breleme Ä°htiyaÃ§ GrafiÄŸi
<!-- MODEL: 12 aylÄ±k gÃ¼breleme ihtiyacÄ±nÄ± DÃ¼ÅŸÃ¼k/Orta/YÃ¼ksek olarak gÃ¶rselleÅŸtir. Renkler: bg-green-300, bg-green-500, bg-green-700, bg-green-900. -->
<div class="bar-chart-container">
    <!-- Ã–rnek (Dinamik olarak deÄŸiÅŸtir): -->
    <div class="bar-chart-month"> <div class="bar bg-green-300" style="height: 20%;"></div>Oca</div>
    <div class="bar-chart-month"> <div class="bar bg-green-300" style="height: 20%;"></div>Åub</div>
    <div class="bar-chart-month"> <div class="bar bg-green-500" style="height: 50%;"></div>Mar</div>
    <div class="bar-chart-month"> <div class="bar bg-green-700" style="height: 80%;"></div>Nis</div>
    <div class="bar-chart-month"> <div class="bar bg-green-900" style="height: 100%;"></div>May</div>
    <div class="bar-chart-month"> <div class="bar bg-green-500" style="height: 60%;"></div>Haz</div>
    <div class="bar-chart-month"> <div class="bar bg-green-300" style="height: 10%;"></div>Tem</div>
    <div class="bar-chart-month"> <div class="bar bg-green-300" style="height: 10%;"></div>AÄŸu</div>
    <div class="bar-chart-month"> <div class="bar bg-green-500" style="height: 40%;"></div>Eyl</div>
    <div class="bar-chart-month"> <div class="bar bg-green-700" style="height: 70%;"></div>Eki</div>
    <div class="bar-chart-month"> <div class="bar bg-green-300" style="height: 20%;"></div>Kas</div>
    <div class="bar-chart-month"> <div class="bar bg-green-300" style="height: 10%;"></div>Ara</div>
</div>

## ğŸ’§ 6. Sulama Takvimi (TarÄ±m Bitkisi)
* **Kritik DÃ¶nemler:** [Ã‡iÃ§eklenme vb.]
* **YÃ¶ntem:** [Damla / YaÄŸmurlama]
* **YardÄ±mcÄ± YouTube VideolarÄ±:**
    * *<a href="YouTube Linki" target="_blank" rel="noopener noreferrer"><i class="fa-brands fa-youtube text-red-600 mr-1"></i> [Video BaÅŸlÄ±ÄŸÄ±]</a>*

### ğŸ“Š YÄ±llÄ±k Sulama Ä°htiyaÃ§ GrafiÄŸi
<!-- MODEL: 12 aylÄ±k sulama ihtiyacÄ±nÄ± gÃ¶rselleÅŸtir. Renkler: bg-blue-300, bg-blue-500, bg-blue-700, bg-blue-900. -->
<div class="bar-chart-container">
    <!-- Ã–rnek (Dinamik olarak deÄŸiÅŸtir): -->
    <div class="bar-chart-month"> <div class="bar bg-blue-300" style="height: 10%;"></div>Oca</div>
    <div class="bar-chart-month"> <div class="bar bg-blue-300" style="height: 10%;"></div>Åub</div>
    <div class="bar-chart-month"> <div class="bar bg-blue-300" style="height: 20%;"></div>Mar</div>
    <div class="bar-chart-month"> <div class="bar bg-blue-500" style="height: 40%;"></div>Nis</div>
    <div class="bar-chart-month"> <div class="bar bg-blue-700" style="height: 70%;"></div>May</div>
    <div class="bar-chart-month"> <div class="bar bg-blue-900" style="height: 100%;"></div>Haz</div>
    <div class="bar-chart-month"> <div class="bar bg-blue-900" style="height: 100%;"></div>Tem</div>
    <div class="bar-chart-month"> <div class="bar bg-blue-700" style="height: 80%;"></div>AÄŸu</div>
    <div class="bar-chart-month"> <div class="bar bg-blue-500" style="height: 50%;"></div>Eyl</div>
    <div class="bar-chart-month"> <div class="bar bg-blue-300" style="height: 20%;"></div>Eki</div>
    <div class="bar-chart-month"> <div class="bar bg-blue-300" style="height: 10%;"></div>Kas</div>
    <div class="bar-chart-month"> <div class="bar bg-blue-300" style="height: 10%;"></div>Ara</div>
</div>

---
<!-- MODEL: EÄŸer Bitki Tipi "Ev-SÃ¼s Bitkisi" ise AÅAÄIDAKÄ° BÃ–LÃœMLERÄ° KULLAN. -->

## ğŸŒ¿ 5. Ev Bitkisi BakÄ±m Bilgileri
* **IÅŸÄ±k:** [AydÄ±nlÄ±k / YarÄ± gÃ¶lge]
* **Sulama:** [SÄ±klÄ±k]
* **Toprak:** [TÃ¼rÃ¼]
* **YardÄ±mcÄ± YouTube VideolarÄ±:**
    * *<a href="YouTube Linki" target="_blank" rel="noopener noreferrer"><i class="fa-brands fa-youtube text-red-600 mr-1"></i> [Video BaÅŸlÄ±ÄŸÄ±]</a>*

## ğŸ¾ 6. Evcil Hayvan GÃ¼venliÄŸi
* **Durum:** [Zehirli / Zehirsiz]
* **Ã–neri:** [UyarÄ±lar]
`;

        // --- DOM Elementleri ---
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const promptInput = document.getElementById('prompt');
        const analyzeButton = document.getElementById('analyzeButton');
        const locationButton = document.getElementById('locationButton');
        const locationText = document.getElementById('locationText');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');
        const analysisResult = document.getElementById('analysisResult');
        
        let base64ImageData = null;
        let weatherData = null; // Hava durumu verisini saklamak iÃ§in

        // --- Olay Dinleyicileri ---

        // FotoÄŸraf yÃ¼klendiÄŸinde Ã¶nizle
        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) {
                base64ImageData = null;
                imagePreview.classList.add('hidden');
                return;
            }
            
            // GÃ¶rÃ¼ntÃ¼yÃ¼ base64'e Ã§evir
            const reader = new FileReader();
            reader.onloadend = () => {
                base64ImageData = reader.result.split(',')[1]; // 'data:image/jpeg;base64,' kÄ±smÄ±nÄ± kaldÄ±r
                imagePreview.src = reader.result;
                imagePreview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        });
        
        // Konum al butonu
        locationButton.addEventListener('click', () => {
            if (WEATHER_API_KEY === "BURAYA_KENDI_API_ANAHTARINIZI_YAPISTIRIN" || WEATHER_API_KEY === "") {
                showError("Hava durumu Ã¶zelliÄŸi iÃ§in geÃ§erli bir OpenWeatherMap API anahtarÄ± gerekli. LÃ¼tfen koddaki 'WEATHER_API_KEY' deÄŸiÅŸkenini gÃ¼ncelleyin.");
                return;
            }
            
            if (!navigator.geolocation) {
                showError("TarayÄ±cÄ±nÄ±z konum servisini desteklemiyor.");
                return;
            }

            locationText.textContent = "AlÄ±nÄ±yor...";
            locationButton.disabled = true;

            navigator.geolocation.getCurrentPosition(async (position) => {
                const { latitude, longitude } = position.coords;
                try {
                    weatherData = await fetchWeather(latitude, longitude);
                    locationText.textContent = `Konum: ${weatherData.city} (Hava Durumu AlÄ±ndÄ±)`;
                    locationButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    locationButton.classList.add('bg-green-600', 'hover:bg-green-700');
                    locationButton.innerHTML = `<i class="fa-solid fa-check mr-2"></i> Hava Durumu AlÄ±ndÄ±`;
                } catch (error) {
                    showError(`Hava durumu alÄ±namadÄ±: ${error.message}`);
                    locationText.textContent = "Konum AlÄ±namadÄ±";
                } finally {
                    locationButton.disabled = false;
                }
            }, (error) => {
                showError("Konum izni reddedildi veya konum alÄ±namadÄ±.");
                locationText.textContent = "Hava Durumu iÃ§in Konum Al";
                locationButton.disabled = false;
            });
        });

        // Analiz et butonu
        analyzeButton.addEventListener('click', runAnalysis);

        // --- Ana Fonksiyonlar ---
        
        // OpenWeatherMap API'den 5 gÃ¼nlÃ¼k hava durumu tahmini Ã§eker
        async function fetchWeather(lat, lon) {
            const weatherApiUrl = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=metric&lang=tr`;
            
            const response = await fetch(weatherApiUrl);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || "Hava durumu sunucusuna baÄŸlanÄ±lamadÄ±.");
            }
            
            const data = await response.json();
            
            // API'den gelen veriyi basitleÅŸtir
            const forecastSummary = data.list.slice(0, 16).map(item => { // YaklaÅŸÄ±k 48 saatlik (16*3 saat)
                return `${item.dt_txt.split(' ')[1].substring(0, 5)}: ${item.weather[0].description}, ${Math.round(item.main.temp)}Â°C, YaÄŸÄ±ÅŸ: ${item.pop * 100}%`;
            }).join('\n');
            
            return {
                city: data.city.name,
                forecast: `Konum: ${data.city.name}\n5 GÃ¼nlÃ¼k Tahmin (3 saatlik aralÄ±klarla):\n${forecastSummary}`
            };
        }

        // --- GÃœNCELLENMÄ°Å runAnalysis Fonksiyonu (Backend Entegrasyonu) ---
        async function runAnalysis() {
            const userPrompt = promptInput.value;
            
            if (!userPrompt && !base64ImageData) {
                showError("LÃ¼tfen bir fotoÄŸraf yÃ¼kleyin veya bir aÃ§Ä±klama girin.");
                return;
            }

            showLoading(true);
            showError(null);
            analysisResult.innerHTML = "";

            // Prompt hazÄ±rlÄ±ÄŸÄ±
            let fullPrompt = systemPrompt;
            if(userPrompt) fullPrompt += "\n\nKULLANICI SORUSU:\n" + userPrompt;
            if (weatherData) fullPrompt += "\n\nKONUM VE HAVA DURUMU VERÄ°SÄ°:\n" + weatherData.forecast;

            // Backend'e gÃ¶nderilecek veri paketi
            const payload = {
                prompt: fullPrompt,
                image: base64ImageData, // Sadece base64 string (data:image... kÄ±smÄ± olmadan)
                mimeType: "image/jpeg"
            };

            try {
                // DÄ°KKAT: ArtÄ±k Google URL'ine deÄŸil, kendi API'mize istek atÄ±yoruz.
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || "Sunucu hatasÄ±: " + response.status);
                }

                // Backend'den gelen cevap yapÄ±sÄ±: { result: "Markdown metni..." }
                const text = data.result;

                if (text) {
                    if (typeof marked === 'undefined') {
                        throw new Error("Markdown kÃ¼tÃ¼phanesi (marked.js) yÃ¼klenemedi.");
                    }
                    analysisResult.innerHTML = marked.parse(text);
                } else {
                    throw new Error("API'den beklenen formatta bir cevap alÄ±namadÄ±.");
                }

            } catch (error) {
                console.error("API HatasÄ±:", error);
                // Canvas ortamÄ±nda olduÄŸumuzu belirten Ã¶zel bir hata mesajÄ±
                if (error.message.includes("404") || error.message.includes("Unexpected token")) {
                    showError("Hata: Backend API bulunamadÄ±. Bu kod Vercel'e deploy edildiÄŸinde Ã§alÄ±ÅŸacaktÄ±r. Canvas Ã¶nizlemesinde '/api/analyze' adresi mevcut deÄŸildir.");
                } else {
                    showError(`Analiz yapÄ±lÄ±rken bir sorun oluÅŸtu: ${error.message}`);
                }
            } finally {
                showLoading(false);
            }
        }

        // --- YardÄ±mcÄ± Fonksiyonlar ---
        
        // YÃ¼kleme gÃ¶stergesini aÃ§/kapat
        function showLoading(isLoading) {
            if (isLoading) {
                loadingIndicator.classList.remove('hidden');
                loadingIndicator.classList.add('flex');
                analyzeButton.disabled = true;
                analyzeButton.classList.add('opacity-50', 'cursor-not-allowed');
                // Ã–nceki sonuÃ§larÄ± temizle
                if (analysisResult.querySelector('.fa-file-medical')) {
                    // Ä°lk aÃ§Ä±lÄ±ÅŸ mesajÄ± varsa dokunma
                } else {
                     analysisResult.innerHTML = '';
                }
            } else {
                loadingIndicator.classList.add('hidden');
                loadingIndicator.classList.remove('flex');
                analyzeButton.disabled = false;
                analyzeButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // Hata mesajÄ±nÄ± gÃ¶ster
        function showError(message) {
            if (message) {
                errorMessage.textContent = message;
                errorContainer.classList.remove('hidden');
            } else {
                errorContainer.classList.add('hidden');
            }
        }

    </script>

</body>
</html>